[env:m5stack-cores3]
platform = espressif32@6.5.0
board = m5stack-cores3
framework = arduino
monitor_speed = 115200
upload_speed = 115200

lib_deps =
  https://github.com/m5stack/M5CoreS3.git
  https://github.com/m5stack/M5Unified.git
  https://registry.platformio.org/search?q=header:USBMassStorage.h
  ; USBマスストレージ機能は、通常、Arduino-ESP32コアに含まれています。
  ; 明示的なライブラリ依存関係は通常不要ですが、もしビルドエラーが発生する場合は、
  ; PlatformIO Registryで "USBMassStorage" や "TinyUSB" を検索して追加を検討してください。

; USBマスストレージ機能を有効にするためのビルドフラグ
; これらのフラグは、Arduinoフレームワークの基盤となるESP-IDF設定に影響を与えます。
build_flags =
  ; USBデバイスモードを有効にする
  -DARDUINO_USB_MODE=1
  ; USBマスストレージクラス (MSC) を有効にする
  -DARDUINO_USB_MSC_ON_BOOT=1
  ; USBシリアル (CDC) を無効にする (マスストレージとの競合を避けるため)
  -DARDUINO_USB_CDC_ON_BOOT=0
  ; USBデバイスのベンダー、プロダクト、シリアル番号の文字列を設定
  -DARDUINO_USB_MANUFACTURER="M5Stack"
  -DARDUINO_USB_PRODUCT="SD Card Reader"
  -DARDUINO_USB_SERIAL="123456"

  ; 基盤となるESP-IDFのTinyUSBコンポーネントを有効にする
  -DCONFIG_TINYUSB_ENABLED=1
  -DCONFIG_TINYUSB_MSC_ENABLED=1
  -DCONFIG_TINYUSB_USBDEV_MSC_BUFFER_SIZE=512 ; MSCバッファサイズ (必要に応じて調整)
  -DCONFIG_TINYUSB_CDC_ENABLED=0 ; TinyUSBレベルでのCDC無効化を再度確認

  ; 基盤となるESP-IDFのSDMMCホストドライバコンポーネントを有効にする
  -DCONFIG_ESP_SDMMC_HOST_ENABLED=1
  -DCONFIG_ESP_VFS_FAT_SDMMC_ENABLED=1
board_build.arduino.usb_cdc = no
